package rpc2

import (
	"bytes"
	"encoding/hex"
	"github.com/ugorji/go/codec"
	"testing"
)

// Test an output from objective C that was breaking the server
func TestObjcOutput(t *testing.T) {
	dat := `cd1a87940005d9216b6579626173652e312e6d796b65792e7361766541726d6f7265645047504b65799183a36b6579da1a3f2d2d2d2d2d424547494e205047502050524956415445204b455920424c4f434b2d2d2d2d2d0a436f6d6d656e743a20475047546f6f6c73202d20687474703a2f2f677067746f6f6c732e6f72670a0a6c51632b424654324775774245414379753032786c343171536c69732b477178336630782b32536f566c6b7751527546576175636a6c334148593257727770620a646b47564a725234544e784333734f2b356e3251596a6a396d306a4c707561434c417139587761466b34795a59324159302b636672644c3532364867647a43650a2b753836356b327731336d5466706d533176756d686d41576934347265576a534739597a4e47636461314d6436474c767377597353336a46303161474b757a770a414973634b7447425a4b456b503054396c413744795562674265487075483561347038646f395239353778365a4d5a48467343776153525233494c64516b34510a6651334d6154773273412b367a324d615845656b64304c3941366379694235545831556f7277537776307a6852545a7a79517a58424258703371447767496e4f0a69486b6170714d566d6e6669304a454d6d536c375678464e56447a643649393732384a6473327a61376a4f4f4156736272514852354a354132455641676d73710a6352485667584f75757448686a77463334376d74355a304e5073574962496276333868486b7a4f555a486b716f386b4f474b38443054536e57706a656a364d500a74783944595355584f70646e6739514f39564b2b706a48713763787976594c556f5368384137725a666f4f426b4f66537761744879656851412b4353463565490a34756b4f692f4d664b7862552f4166314c32305558653766364b6c38554f36654f4275616d7938392f774c756b507351754847316259614a66317857344d69680a6c58335646417456575235677356545657483536704c6b76656238572b613730444451543370374e43563556353873623433514a4a324271586e2f66756a42790a2f445a4c69654555467156647166436c3062652f314c5a5a4857393659712b4e347377682f2b6356584c345969576870412f743531304a7466774152415141420a2f674d44417377457a627a334a3868523435637675554d34536c4137366c7765724e51717171774a506b744835416d707a7a636b2b6e4b497737684968764c610a37394163564467585a6c516566446642576c6179344e51456653766b3268782f2b672f33755946647678592b7768526364617061357a7855766c5336767351750a52662b767067326e574b4e52746d2f5858707159523864483775715234666749594a64474a756a397265334565725839366f556f3561782f46384432586f32480a4c36686f424c4a303464727562623444532f4d784b4f65383569567a4b5a675968624b4e5845683242587a637435646d68642f727137505946444d486b596c4c0a6b304d2b744b7063444a52584653634f59505166326652774a587475364133647562687875446e6b41796c56644a68446d4e692f5057545a496d446e534763420a74746e636666624d6c495565317336592b456e545545384e36385762372b6535767533564d394b592b414c412f4478556e34666b353878512f54325751394e330a51383931424a51776e795656433162685a74757947485a766c545476666e7550543451395a7875344c2b6b6e6870756c317069793762664b414344424e5270770a70376d4641506f6e7330487a5938465154535631584f4f506e564442534b6a6a3866535370384a7142714a6f6352574632565952454c75563464506136435a560a526b796e4a5867656636584e30413976744e4d74597a4c6e47584d366844592f6172382b456b54366430454a486a39346d41796b58617377356548695a4f57300a7261484c637630694e7577514a726d69564e30466e534a7454644d31366437524e3741306c326239433558316739454639376f6148344266336a737539764b470a422f6778344a79782f6c7663362b4a4b44447a44794a586147446d56797873516c5362484357535771326b5553307963367974337a4d6f634869714a656357350a4d34467a4f4f34566b53386478304b39396c37776a4e4976525451616d416436646d534866567a465041436c584a6c306a4b784277676e4c726c68435a724d770a48767837322f643974304c336a6d68683371566b48584d59734d37467342454f70585a684a664368476c374e336e39374c36746258614d48683430326a7756690a4f6c367631754a45776e4f6249485170315364716862526d656b514d4470346c3930573077393469326837503841522b436f763857464d6e4a7071786f7051640a3157446951686c565a7836473942736d546768546a324933424e54663651684b7473424e7159364e7a4632507a6f7a4c61774a7a6949624c47565144683874650a4b7849475673334143304276304f6969787067496c5043737850644c54474968635951784d4c53356e416a44576e72442b553773566b7a484c37424f313952650a48636f51436d7350355835335239303165794836637173374255437751347638623047334f696c5032646e52795361632f436436763179464561464b764b56450a5a626935306d5a7234737a713434494e6e526d6b4a4168484d66646b4f4d33627141724a73434b76556e3574676e5a347759537273436350376a585642724e740a3953796731384b766b716339697a344d75386268343837702b6e5947507a6464714d615256315144334c487746704a536e6a76332b4a5a6d6334534d784d6f430a6b6c76692b444665624c5362426b42796e4c6149567967456b55766a6553496d304358644f6853334d6b6b47424f434d49686c546c31773241736337583434320a58754d514f4575594c59594c6f3235553658454455674879316730724739535731796e6b444e716f74356f307436324378392f46712b674c426564536c4144520a67646a4e5a436c6b7a457a3965334e3255594e5642526e497868457948393443766b546958564f705245426f59426f4f556a4d504373456c4f5a36576d3254390a637852365254486942553050414256393647437a33786257577749567842764d7464574564576b4b7a6d31657843553873304d30457837563757354f3559426c0a7831506544634332357a614d56355946766e4f6771544e4f5a4c75416f6f47653953626e787a734b31476f696c793237304d4e726534682b4a2b615631772b580a664446644b7675725946636e372b624f676b527a634651714f35414a5a786b6357446d4c695a68546d6c3261434b384e57776d376a61306777437258494c66760a6c68673059596a43545a7a706e454b362b444c4f4d766f6a546b6a566a4d74647941474d2f49306a30726c4170447870393871636d37476d6344386e463665330a3350526b78416a4669342b56696868486b6e42706f6e4b7158374d596f75346f4543416b4f6838626a32743957744454726f4e487539667149667456464764500a774142763752335368474e4a49565442766a6a67704a4d7474335a6e504831676b687a676b6f4355783141307442784859574a79615756734946526c633351670a5048526c633352416447567a6443356a6232302b6951493942424d424367416e42514a55396872734168734442516b4868682b414251734a434163444252554b0a4351674c4252594341774541416834424168654141416f4a454a5a307853552f7a3841466b3155502f52776c6e647238627677503349576b786f4f2b4f6545330a5035456563615a47444a464771656e775755316862557838746f755a30767256697444514337444f766346742f62376f396371665a6859454e4f7a52673337630a533763322f55345a454f35384f4f6b355630764e61745855534a465649507167314f5242762b4e62682f3449706443374436592f54544f58316b51434c68356d0a324d5174524a57746f4f356b5268387565366c4b654f58655554627874476355342b3550334f6d483766746d79537967384f35744f474b6f38324f41797134790a583179375a772b34704a445254657352736a64554c766d79754648756358393758692f4e4661385a584e4a2f7463526957594f6a786f73316b772b72444641520a514f594b74536c4938756371636c4d41655077306630496c6d2b5833576f6c653831546a4745433972785641304f4a496f452f583238372f37424b77476a36340a4d79705857796f6762396464554c4a466f6e5a67454931794c64325276576b4558647937683935327663536358764152545442587a6f536a6577766e78652f570a324c636c4b4b6535376a34554f5539714765324177374a6f596b714a3142464551737938464d64393739757734476b476b3153554a65756f68734f4d4b4c33450a655a697645752b3132426e4e4c454c5531302b5150662b3441502f544a666756714b4375525562564c7951544879564b5a5430586633357961494469634b516a0a4d484e2b45414e672f31373756706c683843354562713463354232365055685839414a5a4a7874305a443432656b6e466f505973434137666b6a552b34626e390a6f4a5131473778634e652f424c496277394573492f4c726346786945514d59514553615173445a6c424768705a2b4e74384f46596e6e58704a2b694f50526c490a69496b424d6b4c4c756d714b784d4a4f393436356e516339424654324775774245414435456472306d413730792f4131657a3954306b3748745368446a6a55680a6c6d736f643839714e504662616d7a4f4d744e746f41375657537a6d497549664c6b364f6d3271636e596631456c6f56475232794a5a334144537746374f42770a42506c66493233546e664b6636535a436c676c5357464d4f394d546e736877764f3549394a4b5a7a3846372b356731472b3733325a6155526151756949634e330a3069726e6a784c546f574e6e4b422b6c6b51474d347342797a4f4361474a48597962707a594d547437767535394f33517433734d3647543132544c657766734e0a5661476c515263497834503243776137466330486e3441684b707330734143524534364d70464374394a4f442b316855307a386374706575765a6a754a57394d0a70533947726e646f4a6347666b59325179393449754855492f3368586e6f62594c65774857347754667044305449584c396f48434c6777416f35624245386d6f0a476e506456584a30436e685a6757446a306d5039622b6a2b526472333075636842686f713458575733506f304b794b686e56495349324449616e633963497a530a6e416d2f4e57736650316e3862415a494850634e6952756934374a4c447947532b5956674654616a4b4433744a4d36304f4d70447a6e465067765265613159540a5838435432524f6e52485a473356445747594933776d465a63736a6d587531556d5651563241373839424a35584d4f5a4a725748644c444d69514c35546446660a634941783870737076464a34506f4a4748467764562b387349655146586d502f5241472f4b332f3234784543647a4a77316853343833566b4e424854626264670a6a762f76386b576d6555357a62716e652b4f5a5a63544e4d54396139484a5335675578326c636968334f63312f785a704b637753764a34365831566e494c4f660a2b38452f72646a69786f737643774152415141422f674d44417377457a627a334a38685234385142346c55794263756b456d7646556e512f6d4f4a737742714b0a652b70754147747556665346783936724f38792b4e6b4d6d745974615339624855667a4c6a70394d534f4a6d664953754559326a44774f2b48397a30575473590a426e6e6672586e4b5647744c59384e736632385838655232443941544677694c3639324638305879544c786b4b4e38417a2f2b657a78576650656e394c57414b0a4b77524b306d706175716d46774d464754625758496a652f6f504a785232734b3335686c44474e6c5446675a4a765759355a59543579534d6d646970316a74630a6a796b45637558544d4c456e75497a736546306b714868445a44596751794b74634254706750547343706a69757130744a50594a526853316b6f41567476334f0a2f754d46364e73757630506b3337484236694c5976464166626d4b387476556e315763636370357a375636666438764643626836646c5435674868785579526f0a4e744b414c6279664e4736454865636e4d3962555a6f5a6f784b472f47574a472f3633373038357875542f6e746d53413943374a65355a476e75694e37394f570a316e416f324b58644c6b7759647756635666324753747046692b464f47675a453546592b54614b4c3162323034353744726762426a56465673714a6c644d4d7a0a784b384175624b36796c4b70386345773865494246434e4d434e735435393755484e33576550787872494f313450794b4753486a63516a63352b3969515664540a504275616161666e2b773032334633644d64784a584a6e32545a443272396966362b4a3650472f3633336b4d4d5a674549487467635163646e7547476b6944680a4768547344374634533852693542317153736277766b4558547369336d4b49434757504b7975464b41767872612f6c79534c5a6742656c664f304351303752630a31445333693963703761766d7578793459765a7650326f756e684232455566514c6842374d684f5735395a64476c69567961336458465247645a785636566e540a7771735a707046517237793636426b384953596a334e37652b4a6b674469364e686f5943626f4c774d63542b776f364a6d2f437351685a4f5a71576c704730640a69352f757564467166676c6b7a4c7278785644545267784b424778306b546a4d35723556793474465757683463556e42614635754c573334726b4e64736254780a59313943354b30765a3135546f4c35383143724f575647457353765a65363778596e73626830397a38496a32726d2f46364d6b644d334c6a336b44364b30346b0a615562733046444b3633467030486b746f62644e5a6a3642483934733457734330645341536745614f664b35646843424b36734d67437374677a4454464a72350a6e4a6b377973334b47646f564f4433744c2b2f496244777477376e6a75654d455157637165736b437a4e4138414d6e4c554f345262554d626939466a68544f560a36772b736c6c7576334870632b4a4163394d64472b427871556a5445752b576465706d6a527275796f43527a35387937466f68365976647776356671344634310a6f42483369536d704179755559367542632b344d34353656626369347a424c57676b444f647277566c452f6f3030634a41583178644549614970426a793042340a33536279304138764c366e614461767a746f366d6b30336e5650427a477450596b6a4c51584961794373424a77614c426d7855375a5178764d4577624f5a67490a6843694f6a315a742b377577684e727150564153346c357a3133536f6e475733594b3067694f6c482f5a486e5a6252526a615270375a6757673531482f4237500a38354a6a3530747065767038386f36347a31366e55714c6e79456a534435582b6f6d6b50466e336a66376b54474663476a53394c365132366569474f485a56750a2f6249377858396d46637450643447597365466c566c672b75426f43586e4b3849637a61576d30527670414551784a77693168546c316e6675663172313967560a564f7879704f3964664a49324176725a77354e6f527148764d6b693437464f6a4a5a31565831393264726b62616743775635427058324d61354e753137384b7a0a77686832774645754d6159444a576c547a442f735072486849667a635a436d5868646c537a66776555435743634550574d4e5943627036384363384f764e565a0a527933736e553636593962303366494e57464e683873504d6d58613838414679776f6b76574f6577303666433361464e46377a4d43714245357a394a716d6e720a47332f36756e46785245344166686b6f6431374b563136785a6a45704f77626d4e2f4c735379536d61334a33356637344d53757554423132342f5449565957500a6f66716d733236683541544a63694c6d5a45584b4d7171486d64577937726f42637a476f6f6633525871357a6d467067515a58724b487866657a51384238574a0a416955454741454b41413846416c54324775774347777746435165474834414143676b516c6e54464a542f507741587475412f2b4946335a6136716c6e724d410a6b674169565738556839756f35417a696d4f6f754b6151344e38454972565453796c6544355a76777a7062512b776253734e4d3748306f776e4e5539586553300a2b52526c6d4656707678474b6438635067355a5367566f6168684b386c30764865326b73643148682b71713878426a3962386c6d7879316a565a31654d4a39300a3866514d505157484661474a374b4c7042354d334270565a4a657a4b456971424b5732724c4e53663130633261614379634e4446547938452b68336936686c430a79675962594f43374c39574851312f703934312b474c466b773149706d2b7a586e446b6c45446a4c57672f545941675a4d7958335a3871396a344f64715754770a714535447a65312f6a6b6d682f2b7a7961544d7058564134732f4b524f664a682b4159613965317a305358314458454337574b377873356b7a654f3864786a4d0a44584e45384b437362526b6b7550422f68534a6668565345673732466f6b31304f302f4d774f2b4c31716b487a4d51495a6133324c502f455a3173625a3951560a4777555979464e4e6d506b734e494945454362613573462b396734747159314845525573394a63513145736d512b53364c3757515342516c6a77416335714e510a39475965364567394179334f4e3435336879385655374b317133755361787546516f4b52547a697572726f664634546d6a4933676e716a362f536961522f58550a58396844563347515276434337764d5a6f584b70323557776f5539463048527a42366970664c59626d57314d6a3656683736716e7941787952547a79474845740a35796467544b4a76334e5a687630372b4a6871576276386658777664746c544f456f6b5a31364e36794d6e7a61585a694150415942676c6a794d4f6b43705a710a2f592f44345149714e7578576e7a4771666f6e445279586b65555868592f673d0a3d6f3363650a2d2d2d2d2d454e44205047502050524956415445204b455920424c4f434b2d2d2d2d2d0aaa707573685075626c6963c3ab7075736850726976617465c2`
	v, err := hex.DecodeString(dat)
	if err != nil {
		t.Fatal(err)
	}

	buf := bytes.NewBuffer(v)
	var i int
	mh := codec.MsgpackHandle{WriteExt: true}
	dec := codec.NewDecoder(buf, &mh)
	err = dec.Decode(&i)
	if err != nil {
		t.Fatal(err)
	}

	if i != buf.Len() {
		t.Fatalf("Bad frame: %d != %d", i, buf.Len())
	}

	var a interface{}
	err = dec.Decode(&a)
	if err != nil {
		t.Fatal(err)
	}
}
